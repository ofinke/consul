# ReactAgentFlow Documentation

## Overview
`ReactAgentFlow` is a base class for agent tasks with tool support, designed to implement the ReAct (Reasoning and Acting) agent flow. It is part of the Consul framework and is defined in `src/consul/flows/agents/react.py`. This class enables agents to interact with language models and external tools in a structured, graph-based workflow.

## Class: ReactAgentFlow

### Inheritance
- Inherits from: `BaseFlow`

### Purpose
The `ReactAgentFlow` class orchestrates agent tasks that require both reasoning (via LLMs) and acting (via tool calls). It manages the flow of messages, tool invocations, and the overall agent state using a state graph.

## Key Methods and Properties

### `__init__(self, flow_name: AvailableFlow)`
Initializes the flow with a given name and prepares a mapping for tools by name.

### `input_schema`, `state_schema`, `output_schema`
- All return `BaseGraphState`.
- Define the schema for input, state, and output of the agent flow.

### `get_tools(self) -> list[BaseTool]`
- Returns a list of tools available to the agent, as specified in the configuration.
- Tools are retrieved from the `TOOL_MAPPING` using the flow's config.

### `build_system_prompt(self) -> list[ChatMessage]`
- Constructs the system prompt for the agent using the prompt history from the configuration.
- Formats each prompt turn using `PROMPT_FORMAT_MAPPING`.

### `get_llm(self) -> BaseChatModel`
- Retrieves the language model (LLM) and binds the available tools to it.
- Ensures the LLM can invoke tools as part of its reasoning process.

### `build_graph(self) -> StateGraph`
- Constructs the agent's execution graph using the `StateGraph` class.
- Defines two main nodes:
  - **agent**: Calls the LLM with the message history and appends the LLM's response.
  - **tools**: Checks if the last message contains tool calls and executes them, appending the results as `ToolMessage` objects.
- Sets up conditional transitions:
  - If the last message contains tool calls, transitions to the `tools` node.
  - Otherwise, ends the flow.
- The `tools` node always transitions back to the `agent` node, allowing iterative reasoning and acting.

## Flow Logic
1. **Agent Node**: The agent (LLM) receives the current message history and generates a response, which may include tool calls.
2. **Conditional Transition**: If the response includes tool calls, the flow moves to the `tools` node; otherwise, it ends.
3. **Tools Node**: Executes each tool call, appends the results to the message history, and returns to the agent node for further reasoning.
4. **Repeat or End**: The process repeats until the agent's response does not include further tool calls.

## Integration
- **Tools**: Tools are dynamically loaded based on the flow configuration and are made available to the LLM.
- **Prompts**: System prompts are built from configurable prompt history, allowing flexible agent behavior.
- **Logging**: Tool calls and responses are logged for debugging and traceability.

## Usage
To use `ReactAgentFlow`, instantiate it with a valid flow name (from `AvailableFlow`). The flow will automatically manage the interaction between the LLM and tools according to the defined graph.

## Related Components
- `BaseFlow`, `BaseGraphState`: Provide foundational flow and state management.
- `TOOL_MAPPING`, `PROMPT_FORMAT_MAPPING`: Configuration mappings for tools and prompts.
- `StateGraph`: Manages the execution graph for the agent's reasoning and acting steps.

## Note
This documentation was generated by AI flow 'docs' from Consul program (https://github.com/ofinke/consul) using LLM model gpt-4-1106-preview.