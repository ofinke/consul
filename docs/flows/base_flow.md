# BaseFlow Documentation

## Overview
`BaseFlow` is an abstract base class for all task flows in the Consul framework, defined in `src/consul/flows/base.py`. It provides a standardized interface and core capabilities for implementing custom flows that interact with language models, manage state, and execute graph-based workflows. All specific task flows should inherit from this class to ensure consistency and reusability.

## Class: BaseFlow

### Inheritance
- Inherits from: `ABC` (Abstract Base Class)

### Purpose
The `BaseFlow` class defines the essential structure and lifecycle for any flow in the Consul system. It enforces the implementation of key methods and schemas, manages configuration, and provides common logic for preparing and executing flows using LangGraph and language models.

## Key Components

### Input, State, and Output Schemas
- **BaseFlowInput**: Base input schema (Pydantic model). Subclasses should define their own input schema by extending this.
- **BaseGraphState**: Base state schema for the LangGraph graph, containing a sequence of messages. Used to track the evolving state during flow execution.
- **BaseFlowOutput**: Base output schema, typically used to restrict or format what is returned to the user after flow execution.

### Initialization
#### `__init__(self, flow_name: AvailableFlow)`
Initializes the flow with a specific name, setting up internal attributes for configuration, system prompt, graph, compiled graph, and language model interface. The flow name determines which configuration and behavior the flow will use.

#### Attributes
- `_flow_name`: The name of the flow/task (used to fetch configuration).
- `_system_prompt`: Cached list of system prompt messages for the flow.
- `_graph`: The uncompiled LangGraph graph instance.
- `_compiled_graph`: The compiled graph, ready for execution.
- `_llm`: The language model interface (e.g., AzureChatOpenAI) for LLM calls.

### Configuration
#### `config` (property)
Fetches the flow's configuration using the flow name. Returns a `BaseFlowConfig` object.

### Abstract Methods and Properties
Subclasses must implement the following:
- `input_schema`: Returns the input schema for the flow (should be a subclass of `BaseFlowInput`).
- `state_schema`: Returns the state schema for the flow (should be a subclass of `BaseGraphState`).
- `output_schema`: Returns the output schema for the flow (should be a subclass of `BaseFlowOutput`).
- `build_system_prompt()`: Prepares and returns the system prompt as a list of `ChatMessage` objects.
- `build_graph()`: Constructs and returns the LangGraph `StateGraph` for the flow.

### Common Interface and Core Logic

#### `get_llm(self) -> BaseChatModel`
Instantiates and returns the language model interface (e.g., AzureChatOpenAI) using the flow's configuration and credentials.

#### `prepare_to_run(self, input_data: dict[str, any]) -> BaseFlowInput`
Prepares the flow for execution by:
- Validating and parsing input data using the input schema.
- Building the system prompt if not already cached.
- Instantiating the LLM interface if not already set.
- Building and compiling the graph if not already done.
Returns the validated input object.

#### `execute(self, input_data: dict[str, any]) -> BaseGraphState`
Runs the flow with the provided input data. Internally calls `prepare_to_run`, then invokes the compiled graph with the validated input, and returns the resulting state as defined by the state schema.

#### (Planned) `aexecute(self, input_data: dict[str, any]) -> BaseGraphState`
An asynchronous version of `execute` is planned but not yet implemented.

## Flow Lifecycle
1. **Initialization**: The flow is instantiated with a flow name, setting up internal state.
2. **Preparation**: On execution, input is validated, the system prompt and LLM are prepared, and the graph is built and compiled if needed.
3. **Execution**: The compiled graph is invoked with the validated input, producing a new state.
4. **Output**: The resulting state is returned, formatted according to the output schema.

## Extending BaseFlow
To create a custom flow, subclass `BaseFlow` and implement all required abstract methods and properties. Define custom input, state, and output schemas as needed for your task.

## Related Components
- `BaseFlowInput`, `BaseGraphState`, `BaseFlowOutput`: Schemas for input, state, and output.
- `BaseFlowConfig`: Configuration object for flows.
- `StateGraph`: Manages the execution graph for the flow.
- `AzureChatOpenAI`, `BaseChatModel`: Language model interfaces.

## Note
This documentation was generated by AI flow 'docs' from Consul program (https://github.com/ofinke/consul) using LLM model gpt-4-1106-preview.
